<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Мини-приложение</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        :root {
            --vh: 1vh;
        }
        html, body {
            height: calc(var(--vh, 1vh) * 100);
        }
    </style>
</head>
<body>
    <div class="header">
        <button id="back-button" onclick="goBack()" style="display: none;">
            <img src="/static/back.svg" alt="Назад">
        </button>
        <img src="/static/logo22.png" alt="Логотип" class="logo">
    </div>

    <div class="menu-vertical" id="content">
        <button onclick="showRegions()">Адреса магазинов</button>
        <button onclick="showSection('catalog')">Каталог товаров</button>
        <button onclick="showSection('review')">Оставить отзыв</button>
        <button onclick="showSection('contacts')">Контакты</button>
        <button onclick="showSection('jobs')">Вакансии</button>
        <button onclick="showSection('promotions')">Акции</button>
    </div>

    <div class="footer-buttons">
        <div id="home-button" onclick="goHome()">
            <img src="/static/home.svg" alt="Домой">
        </div>
        <div id="login-button" onclick="auth()">
            <img src="/static/login.svg" alt="Авторизация">
        </div>
    </div>

    <div class="cart-button-container">
        <button onclick="openCart()" class="cart-button">
            <img src="/static/shop.svg" alt="Корзина">
        </button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const setFullHeight = () => {
                document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
            };
            window.addEventListener('resize', setFullHeight);
            window.addEventListener('load', setFullHeight);
            setFullHeight();

            document.body.style.overflow = 'hidden';
            document.body.style.userSelect = 'none';
            document.addEventListener('dblclick', (e) => e.preventDefault());

            if (window.Telegram?.WebApp) {
                Telegram.WebApp.expand();
                Telegram.WebApp.ready();
            } else {
                document.body.innerHTML = "Ошибка: откройте через Telegram!";
                return;
            }

            let currentState = "home";
            let currentRegion = null;
            let currentCity = null;

            async function loadData(url) {
                try {
                    const response = await fetch(`/api/${url}`);
                    if (!response.ok) throw new Error("Ошибка загрузки данных");
                    return await response.json();
                } catch (error) {
                    console.error(error);
                    return null;
                }
            }

            function showContent(content, showBack = true) {
                const contentDiv = document.getElementById('content');
                document.getElementById('back-button').style.display = showBack ? 'block' : 'none';
                contentDiv.classList.add('hidden');
                setTimeout(() => {
                    contentDiv.innerHTML = content;
                    setTimeout(() => {
                        contentDiv.classList.remove('hidden');
                    }, 50);
                }, 300);
            }

            function goBack() {
                if (currentState === "regions") {
                    showHome();
                } else if (currentState === "cities") {
                    showRegions();
                } else if (currentState === "stores") {
                    showCities(currentRegion);
                } else if (currentState === "storeDetails") {
                    showStores(currentCity, currentRegion);
                }
            }

            function showHome() {
                currentState = "home";
                showContent(`
                    <button onclick="showRegions()">Адреса магазинов</button>
                    <button onclick="showSection('catalog')">Каталог товаров</button>
                    <button onclick="showSection('review')">Оставить отзыв</button>
                    <button onclick="showSection('contacts')">Контакты</button>
                    <button onclick="showSection('jobs')">Вакансии</button>
                    <button onclick="showSection('promotions')">Акции</button>
                `, false);
            }

            async function showRegions() {
                currentState = "regions";
                const regions = await loadData('regions');
                if (regions) {
                    const buttons = regions.map(region => `<button onclick='showCities(${JSON.stringify(region)})'>${region}</button>`).join('');
                    showContent(`<h3>Выберите область:</h3>${buttons}`, true);
                }
            }

            async function showCities(region) {
                currentState = "cities";
                currentRegion = region;
                const cities = await loadData(`cities/${region}`);
                if (cities) {
                    const buttons = cities.map(city => `<button onclick='showStores(${JSON.stringify(city)}, ${JSON.stringify(region)})'>${city}</button>`).join('');
                    showContent(`<h3>Города в области "${region}":</h3>${buttons}`, true);
                }
            }

            async function showStores(city, region) {
                currentState = "stores";
                currentCity = city;
                const stores = await loadData(`stores/${region}/${city}`);
                if (stores) {
                    const buttons = stores.map(store => `<button onclick='showStoreDetails(${JSON.stringify(store.name)})'>${store.name}</button>`).join('');
                    showContent(`<h3>Магазины в городе "${city}":</h3>${buttons}`, true);
                }
            }

            async function showStoreDetails(storeName) {
                currentState = "storeDetails";
                const stores = await loadData(`stores/${currentRegion}/${currentCity}`);
                const store = stores.find(s => s.name === storeName);
                if (store) {
                    showContent(`
                        <h3>${store.name}</h3>
                        <p><strong>Адрес:</strong> ${store.address}</p>
                        <p><strong>Режим работы:</strong> ${store.hours.replace(/\n/g, '<br>')}</p>
                        <button onclick='window.open("${store.map_url}", "_blank")'>Посмотреть на карте</button>
                    `, true);
                }
            }

            function goHome() {
                showHome();
            }

            function auth() {
                alert("Функция авторизации в разработке!");
            }

            function openCart() {
                alert("Функция корзины в разработке!");
            }

            function showSection(section) {
                if (section === 'contacts') {
                    showContent(`
                        <h3>Свяжитесь с нами</h3>
                        <button onclick="copyPhoneNumber()">Позвонить: +375 29 225-13-34</button>
                        <button onclick="window.open('https://www.instagram.com/nekuri.by/', '_blank')">Instagram</button>
                        <button onclick="window.open('https://t.me/nekuri_by', '_blank')">Telegram канал</button>
                        <button onclick="window.open('https://t.me/nekuri_by_brest', '_blank')">Telegram чат</button>
                        <button onclick="window.open('https://vk.com/nekuribrest', '_blank')">ВКонтакте</button>
                        <button onclick="window.open('https://www.tiktok.com/@nekuri.by', '_blank')">TikTok</button>
                    `, false);
                } else {
                    alert(`Раздел "${section}" в разработке!`);
                }
            }
            function copyPhoneNumber() {
                const phoneNumber = '+375292251334';

                // Проверяем поддержку clipboard API
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(phoneNumber).then(() => {
                        showToast('Номер скопирован');
                    }).catch(err => {
                        fallbackCopyText(phoneNumber);
                    });
                } else {
                    // fallback для старых браузеров / WebView
                    fallbackCopyText(phoneNumber);
                }
            }

            function fallbackCopyText(text) {
                const input = document.createElement('textarea');
                input.value = text;
                input.style.position = 'fixed';  // не scroll-бар
                input.style.left = '-9999px';
                document.body.appendChild(input);
                input.focus();
                input.select();

                try {
                    document.execCommand('copy');
                    showToast('Номер скопирован');
                } catch (err) {
                    alert('Не удалось скопировать номер: ' + err);
                }

                document.body.removeChild(input);
            }

            function showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 2000);
            }


            // Делать функции доступными глобально
            window.showRegions = showRegions;
            window.showCities = showCities;
            window.showStores = showStores;
            window.showStoreDetails = showStoreDetails;
            window.showHome = showHome;
            window.goHome = goHome;
            window.auth = auth;
            window.openCart = openCart;
            window.goBack = goBack;
            window.showSection = showSection;
        });
    </script>
</body>
</html>
