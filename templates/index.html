<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Мини-приложение</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        :root {
            --vh: 1vh;
        }
        html, body {
            height: calc(var(--vh, 1vh) * 100);
        }
    </style>
</head>
<body>
    <div class="header">
        <button id="back-button" onclick="goBack()" style="display: none;">
            <img src="/static/back.svg" alt="Назад">
        </button>
        <img src="/static/logo22.png" alt="Логотип" class="logo">
    </div>

    <div class="menu-vertical" id="content">
        <button onclick="showRegions()">Адреса магазинов</button>
        <button onclick="showSection('catalog')">Каталог товаров</button>
        <button onclick="showSection('review')">Оставить отзыв</button>
        <button onclick="showSection('contacts')">Контакты</button>
        <button onclick="showSection('jobs')">Вакансии</button>
        <button onclick="showSection('promotions')">Акции</button>
    </div>

    <div class="footer-buttons">
        <div id="home-button" onclick="goHome()">
            <img src="/static/home.svg" alt="Домой">
        </div>
        <div id="login-button" onclick="auth()">
            <img src="/static/login.svg" alt="Авторизация">
        </div>
    </div>

    <div class="cart-button-container">
        <button onclick="openCart()" class="cart-button">
            <img src="/static/shop.svg" alt="Корзина">
        </button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const setFullHeight = () => {
                document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
            };
            window.addEventListener('resize', setFullHeight);
            window.addEventListener('load', setFullHeight);
            setFullHeight();

            document.body.style.overflow = 'hidden';
            document.body.style.userSelect = 'none';
            document.addEventListener('dblclick', (e) => e.preventDefault());

            if (window.Telegram?.WebApp) {
                Telegram.WebApp.expand();
                Telegram.WebApp.ready();
            } else {
                document.body.innerHTML = "Ошибка: откройте через Telegram!";
                return;
            }

            let currentState = "home";
            let currentRegion = null;
            let currentCity = null;

            async function loadData(url) {
                try {
                    const response = await fetch(`/api/${url}`);
                    if (!response.ok) throw new Error("Ошибка загрузки данных");
                    return await response.json();
                } catch (error) {
                    console.error(error);
                    return null;
                }
            }

            function showContent(content, showBack = true) {
                const contentDiv = document.getElementById('content');
                document.getElementById('back-button').style.display = showBack ? 'block' : 'none';
                contentDiv.classList.add('hidden');
                setTimeout(() => {
                    contentDiv.innerHTML = content;
                    setTimeout(() => {
                        contentDiv.classList.remove('hidden');
                    }, 50);
                }, 500);
            }

            function goBack() {
                if (currentState === "regions") {
                    showHome();
                } else if (currentState === "cities") {
                    showRegions();
                } else if (currentState === "stores") {
                    showCities(currentRegion);
                } else if (currentState === "storeDetails") {
                    showStores(currentCity, currentRegion);
                }
            }

            function showHome() {
                currentState = "home";
                showContent(`
                    <button onclick="showRegions()">Адреса магазинов</button>
                    <button onclick="showSection('catalog')">Каталог товаров</button>
                    <button onclick="showSection('review')">Оставить отзыв</button>
                    <button onclick="showSection('contacts')">Контакты</button>
                    <button onclick="showSection('jobs')">Вакансии</button>
                    <button onclick="showSection('promotions')">Акции</button>
                `, false);
            }

            async function showRegions() {
                currentState = "regions";
                const regions = await loadData('regions');
                if (regions) {
                    const buttons = regions.map(region => `<button onclick=\"showCities('${region}')\">${region}</button>`).join('');
                    showContent(`<h3>Выберите область:</h3>${buttons}`);
                }
            }

            async function showCities(region) {
                currentState = "cities";
                currentRegion = region;
                const cities = await loadData(`cities/${region}`);
                if (cities) {
                    const buttons = cities.map(city => `<button onclick=\"showStores('${city}', '${region}')\">${city}</button>`).join('');
                    showContent(`<h3>Города в области \"${region}\":</h3>${buttons}`);
                }
            }

            async function showStores(city, region) {
                currentState = "stores";
                currentCity = city;
                const stores = await loadData(`stores/${region}/${city}`);
                if (stores) {
                    const buttons = stores.map(store => `<button onclick=\"showStoreDetails('${store.name}')\">${store.name}</button>`).join('');
                    showContent(`<h3>Магазины в городе \"${city}\":</h3>${buttons}`);
                }
            }

            async function showStoreDetails(storeName) {
                currentState = "storeDetails";
                const stores = await loadData(`stores/${currentRegion}/${currentCity}`);
                const store = stores.find(s => s.name === storeName);
                if (store) {
                    showContent(`
                        <h3>${store.name}</h3>
                        <p><strong>Адрес:</strong> ${store.address}</p>
                        <p><strong>Режим работы:</strong> ${store.hours.replace(/\n/g, '<br>')}</p>
                        <button onclick=\"window.open('${store.map_url}', '_blank')\">Посмотреть на карте</button>
                    `);
                }
            }

            function goHome() {
                showHome();
            }

            function auth() {
                alert("Функция авторизации в разработке!");
            }

            function openCart() {
                alert("Функция корзины в разработке!");
            }

            function showSection(section) {
                alert(`Раздел \"${section}\" в разработке!`);
            }
        });
    </script>
</body>
</html>
