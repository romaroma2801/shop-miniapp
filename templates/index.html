<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Permissions-Policy" content="clipboard-write">
    <meta http-equiv="Permissions-Policy" content="clipboard-write, vibration">
    <title>Мини-приложение</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        :root {
            --vh: 1vh;
        }
        html, body {
            height: calc(var(--vh, 1vh) * 100);
        }
    </style>
</head>
<body>
    
    <button id="back-button" onclick="goBack()" style="display: none;">
        <img src="/static/back.svg" alt="Назад">
    </button>
    <div class="header">
        <img src="/static/logo22.png" alt="Логотип" class="logo">
    </div>

    <div class="menu-vertical" id="content">
        <button onclick="showRegions()">Адреса магазинов</button>
        <button onclick="showSection('catalog')">Каталог товаров</button>
        <button onclick="showSection('review')">Оставить отзыв</button>
        <button onclick="showSection('contacts')">Контакты</button>
        <button onclick="showSection('jobs')">Вакансии</button>
        <button onclick="showSection('promotions')">Акции</button>
    </div>

    <div class="footer-buttons">
        <div id="home-button" onclick="goHome()">
            <img src="/static/home.svg" alt="Домой">
        </div>
        <div id="login-button">
            <img src="/static/login.svg" alt="Авторизация">
        </div>
    </div>

    <div class="cart-button-container">
        <button class="cart-button" id="cart-button">
            <img src="/static/shop.svg" alt="Корзина">
        </button>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
                function openCart() {
                    alert("Функция корзины в разработке!");
                }
                function copyPhoneNumber() {
                    const phone = "+375 29 225-13-34";
                    
                    // Fallback для старых браузеров
                    const fallbackCopy = () => {
                        const textarea = document.createElement('textarea');
                        textarea.value = phone;
                        textarea.style.position = 'fixed';
                        document.body.appendChild(textarea);
                        textarea.select();
                        
                        try {
                            const success = document.execCommand('copy');
                            showToast(success ? "Номер скопирован!" : "Не удалось скопировать");
                        } catch (err) {
                            showToast("Ошибка при копировании");
                        } finally {
                            document.body.removeChild(textarea);
                        }
                    };
                
                    // Современный способ
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(phone)
                            .then(() => {
                                showToast("Номер скопирован в буфер обмена!");
                                try {
                                    if (navigator.vibrate) navigator.vibrate(50);
                                } catch (e) {
                                    console.log("Вибрация не сработала");
                                }
                            })
                            .catch((err) => {
                                console.error("Clipboard error:", err);
                                fallbackCopy(); // Пробуем старый способ
                            });
                    } else {
                        fallbackCopy();
                    }
                }
                document.querySelector('.cart-button').addEventListener('click', openCart);
                // ===== НАЧАЛО ВСТАВКИ =====
                // Фоновая регистрация пользователя при загрузке
                if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
                    const tgUser = Telegram.WebApp.initDataUnsafe.user;
                    const userKey = `user_${tgUser.id}`;
        
                    // Проверяем, когда последний раз обновляли данные
                    const lastUpdate = localStorage.getItem(`${userKey}_last_update`);
                    const now = Date.now();
        
                    // Обновляем данные, если они старые (старше 5 минут)
                    if (!lastUpdate || (now - parseInt(lastUpdate)) > 300000) {
                        (async () => {
                            try {
                                const response = await fetch(`/api/get-user?username=${encodeURIComponent(tgUser.username || `id${tgUser.id}`)}`);
                                const result = await response.json();
                    
                                const userData = {
                                    id: tgUser.id,
                                    username: tgUser.username || `id${tgUser.id}`,
                                    first_name: result.exists ? result.user.Name : tgUser.first_name || '',
                                    phone: result.exists ? result.user.Phone : tgUser.phone_number || '',
                                    photo_url: tgUser.photo_url || '/static/user-avatar.png',
                                    updated_at: now
                                };
                    
                                localStorage.setItem(userKey, JSON.stringify(userData));
                                localStorage.setItem(`${userKey}_last_update`, now.toString());
                    
                                if (!result.exists) {
                                    await fetch('/api/save-user', {
                                        method: 'POST',
                                        headers: {'Content-Type': 'application/json'},
                                        body: JSON.stringify({
                                            username: userData.username,
                                            name: userData.first_name,
                                            phone: userData.phone
                                        })
                                    });
                                }
                            } catch (error) {
                                console.error('Фоновая синхронизация не удалась:', error);
                            }
                        })();
                    }
                }
                // ===== КОНЕЦ ВСТАВКИ =====
            const setFullHeight = () => {
                document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
            };
            window.addEventListener('resize', setFullHeight);
            window.addEventListener('load', setFullHeight);
            setFullHeight();

            document.body.style.overflow = 'hidden';
            document.body.style.userSelect = 'none';
            document.addEventListener('dblclick', (e) => e.preventDefault());
            document.getElementById('back-button').addEventListener('click', goBack);
            document.getElementById('login-button').addEventListener('click', function() {
                if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
                    window.location.href = '/user';
                    document.getElementById('content').classList.add('fade-out');
        
                    // Обновляем историю
                    window.history.pushState({}, '', '/user');
        
                    setTimeout(() => {
                        window.location.href = '/user';
                    }, 300);
                } else {
                    Telegram.WebApp.openTelegramLink('https://t.me/Shop_NEKURIBY_bot?start=login');
                }
            });
            document.getElementById('home-button').addEventListener('click', function() {
                console.log('Home button clicked');
                goHome();
            });
            if (window.Telegram?.WebApp) {
                Telegram.WebApp.expand();
                Telegram.WebApp.ready();
            } else {
                document.body.innerHTML = "Ошибка: откройте через Telegram!";
                return;
            }

            let currentState = "home";
            let currentRegion = null;
            let currentCity = null;
            showHome();
            const contentDiv = document.getElementById('content');

            contentDiv.addEventListener('click', (e) => {
                if (e.target.closest('#back-button')) {
                    goBack();
                    return;
                }
                const promoItem = e.target.closest('[data-action="showPromoDetail"]');
                if (promoItem) {
                    const promoData = JSON.parse(promoItem.dataset.promo);
                    showPromotionDetail(promoData);
                    return;
                }
                const btn = e.target.closest('button');
                if (!btn) return;

                const action = btn.dataset.action;
                if (action) {
                    console.log("Нажата кнопка:", action);
        
                    if (action === 'regions') showRegions();
                    else if (action.startsWith('section:')) showSection(action.split(':')[1]);
                    else if (action.startsWith('city:')) showCities(action.split(':')[1]);
                    else if (action.startsWith('store:')) {
                        const [_, city, region] = action.split(':');
                        showStores(city, region);
                    } else if (action.startsWith('detail:')) {
                        showStoreDetails(action.split(':')[1]);
                    } else if (action === 'goHome') {
                        goHome();
                    }
                }

                const starEl = e.target.closest('.star');
                if (starEl && starEl.dataset.stars) {
                    const count = parseInt(starEl.dataset.stars);
                    selectStars(count);
                }


                const submitBtn = e.target.closest('#submit-review');
                if (submitBtn) {
                    submitReview();
                }
            });

            async function loadData(url) {
                try {
                    const response = await fetch(`/api/${url}`);
                    if (!response.ok) throw new Error("Ошибка загрузки данных");
                    return await response.json();
                } catch (error) {
                    console.error(error);
                    return null;
                }
            }

            function showToast(message, duration = 2000) {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0,0,0,0.7);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 4px;
                    z-index: 1000;
                    opacity: 0;
                    transition: opacity 0.3s;
                `;
                document.body.appendChild(toast);
                
                setTimeout(() => toast.style.opacity = 1, 10);
                setTimeout(() => {
                    toast.style.opacity = 0;
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
            function showContent(content, showBack = true, onRendered = null) {
                const contentDiv = document.getElementById('content');
                const backButton = document.getElementById('back-button');
                const carousels = document.querySelectorAll('.promotions-carousel');
                carousels.forEach(carousel => {
                    const intervalId = carousel.dataset.intervalId;
                    if (intervalId) clearInterval(intervalId);
                });
                if (backButton) {
                    backButton.style.display = showBack ? 'block' : 'none';
                } else {
                    console.warn('⚠️ #back-button не найден в DOM');
                }

                contentDiv.classList.add('hidden');
                setTimeout(() => {
                    contentDiv.innerHTML = content;
                    setTimeout(() => {
                        contentDiv.classList.remove('hidden');
                        if (typeof onRendered === 'function') onRendered();
                    }, 50);
                }, 300);
            }



            function showHome() {
                currentState = "home";
                
                // Загружаем акции для карусели
                loadPromotionsForCarousel().then(carouselHTML => {
                    showContent(`
                        <button data-action="regions">Адреса магазинов</button>
                        <button data-action="section:catalog">Каталог товаров</button>
                        <button data-action="section:review">Оставить отзыв</button>
                        <button data-action="section:contacts">Контакты</button>
                        <button data-action="section:jobs">Вакансии</button>
                        <button data-action="section:promotions">Акции</button>
                        
                        ${carouselHTML}
                    `, false, () => {
                        initCarousel();
                    });
                });
            }
            async function loadPromotionsForCarousel() {
                try {
                    // Пробуем загрузить свежие акции
                    const response = await fetch('https://nekuri.by/api/news-feed.php');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const promotions = await response.json();
                    
                    // Если нет свежих, пробуем загрузить из кэша
                    if (!Array.isArray(promotions) || promotions.length === 0) {
                        const cached = localStorage.getItem('cachedPromotions');
                        if (cached) return createCarouselHTML(JSON.parse(cached).slice(0, 5));
                        return ''; // Если вообще нет акций, возвращаем пустую строку
                    }
                    
                    // Сохраняем в кэш и возвращаем HTML
                    localStorage.setItem('cachedPromotions', JSON.stringify(promotions));
                    localStorage.setItem('promotionsCacheTime', Date.now().toString());
                    return createCarouselHTML(promotions.slice(0, 5));
                } catch (error) {
                    console.error("Ошибка загрузки акций для карусели:", error);
                    const cached = localStorage.getItem('cachedPromotions');
                    if (cached) return createCarouselHTML(JSON.parse(cached).slice(0, 5));
                    return ''; // Если ошибка и нет кэша, возвращаем пустую строку
                }
            }
            
            function createCarouselHTML(promotions) {
                if (!promotions || promotions.length === 0) return '';
                
                const slides = promotions.map(promo => `
                    <div class="carousel-slide">
                        <div class="carousel-banner" data-promo='${JSON.stringify(promo).replace(/'/g, "\\'")}'>
                            <img src="${promo.image}" alt="${promo.title}" 
                                 onerror="this.onerror=null;this.src='/static/no-image.png'">
                        </div>
                    </div>
                `).join('');
                
                const indicators = promotions.map((_, index) => `
                    <div class="carousel-indicator ${index === 0 ? 'active' : ''}" data-index="${index}"></div>
                `).join('');
                
                return `
                    <div class="promotions-carousel">
                        <div class="carousel-container">
                            ${slides}
                        </div>
                        <div class="carousel-indicators">
                            ${indicators}
                        </div>
                    </div>
                `;
            }
            
            function initCarousel() {
                const carousel = document.querySelector('.promotions-carousel');
                if (!carousel) return;
                
                const container = carousel.querySelector('.carousel-container');
                const slides = carousel.querySelectorAll('.carousel-slide');
                const indicators = carousel.querySelectorAll('.carousel-indicator');
                const banners = carousel.querySelectorAll('.carousel-banner');
                
                let currentIndex = 0;
                let intervalId;
                let isDragging = false;
                let startPos = 0;
                let currentTranslate = 0;
                let prevTranslate = 0;
                
                // Автопрокрутка
                function startAutoSlide() {
                    intervalId = setInterval(() => {
                        goToSlide((currentIndex + 1) % slides.length);
                    }, 3000);
                }
                
                function goToSlide(index) {
                    currentIndex = index;
                    updateCarousel();
                }
                
                function updateCarousel() {
                    container.style.transform = `translateX(-${currentIndex * 100}%)`;
                    
                    // Обновляем индикаторы
                    indicators.forEach((indicator, i) => {
                        indicator.classList.toggle('active', i === currentIndex);
                    });
                }
                
                // Обработчики свайпа
                container.addEventListener('touchstart', (e) => {
                    isDragging = true;
                    startPos = e.touches[0].clientX;
                    clearInterval(intervalId);
                });
                
                container.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    const currentPosition = e.touches[0].clientX;
                    const diff = currentPosition - startPos;
                    container.style.transform = `translateX(calc(-${currentIndex * 100}% + ${diff}px))`;
                });
                
                container.addEventListener('touchend', (e) => {
                    if (!isDragging) return;
                    isDragging = false;
                    
                    const endPos = e.changedTouches[0].clientX;
                    const diff = endPos - startPos;
                    
                    if (diff > 50 && currentIndex > 0) {
                        goToSlide(currentIndex - 1);
                    } else if (diff < -50 && currentIndex < slides.length - 1) {
                        goToSlide(currentIndex + 1);
                    } else {
                        goToSlide(currentIndex);
                    }
                    
                    startAutoSlide();
                });
                
                // Клик по баннеру
                banners.forEach(banner => {
                    banner.addEventListener('click', () => {
                        const promoData = JSON.parse(banner.dataset.promo);
                        showPromotionDetail(promoData);
                    });
                });
                
                // Клик по индикатору
                indicators.forEach(indicator => {
                    indicator.addEventListener('click', () => {
                        const index = parseInt(indicator.dataset.index);
                        goToSlide(index);
                        clearInterval(intervalId);
                        startAutoSlide();
                    });
                });
                
                startAutoSlide();
            }
            function goBack() {
                console.log("🔙 goBack вызван. currentState =", currentState);
                if (currentState === "promotionDetail") {
                    // Возвращаемся к списку акций вместо главного меню
                    showPromotions();
                } else if (currentState === "regions") {
                    showHome();
                } else if (currentState === "cities") {
                    showRegions();
                } else if (currentState === "stores") {
                    showCities(currentRegion);
                } else if (currentState === "storeDetails") {
                    showStores(currentCity, currentRegion);
                } else if (["review", "contacts", "jobs", "promotions"].includes(currentState)) {
                    showHome();
                } else {
                    console.warn("❓ Неизвестное состояние:", currentState);
                    showHome();
                }
            }




            async function showRegions() {
                currentState = "regions";
                const regions = await loadData('regions');
                if (regions) {
                    const buttons = regions.map(region =>
                        `<button data-action="city:${region}">${region}</button>`).join('');
                    showContent(`<h3>Выберите область:</h3>${buttons}`, true);
                }
            }

            async function showCities(region) {
                currentState = "cities";
                currentRegion = region;
                const cities = await loadData(`cities/${region}`);
                if (cities) {
                    const buttons = cities.map(city =>
                        `<button data-action="store:${city}:${region}">${city}</button>`).join('');
                    showContent(`<h3>Города в области "${region}":</h3>${buttons}`, true);
                }
            }

            async function showStores(city, region) {
                currentState = "stores";
                currentCity = city;
                const stores = await loadData(`stores/${region}/${city}`);
                if (stores) {
                    const buttons = stores.map(store =>
                        `<button data-action="detail:${store.name}">${store.name}</button>`).join('');
                    showContent(`<h3>Магазины в городе "${city}":</h3>${buttons}`, true);
                }
            }

            async function showStoreDetails(storeName) {
                currentState = "storeDetails";
                const stores = await loadData(`stores/${currentRegion}/${currentCity}`);
                const store = stores.find(s => s.name === storeName);
                if (store) {
                    showContent(`
                        <h3>${store.name}</h3>
                        <p><strong>Адрес:</strong> ${store.address}</p>
                        <p><strong>Режим работы:</strong> ${store.hours.replace(/\n/g, '<br>')}</p>
                        <button class="secondary" onclick='window.open("${store.map_url}", "_blank")'>Посмотреть на карте</button>
                    `, true);
                }
            }

            function showSection(section) {
                if (section === 'contacts') {
                    currentState = "contacts";
                    showContent(`
                        <h3>Свяжитесь с нами</h3>
                        <button id="copy-phone-btn">Позвонить: +375 29 225-13-34</button>
                        <button onclick="window.open('https://www.instagram.com/nekuri.by/', '_blank')">Instagram</button>
                        <button onclick="window.open('https://t.me/nekuri_by', '_blank')">Telegram канал</button>
                        <button onclick="window.open('https://t.me/nekuri_by_brest', '_blank')">Telegram чат</button>
                        <button onclick="window.open('https://vk.com/nekuribrest', '_blank')">ВКонтакте</button>
                        <button onclick="window.open('https://www.tiktok.com/@nekuri.by', '_blank')">TikTok</button>
                    `, true, () => {
                        document.getElementById('copy-phone-btn').addEventListener('click', function() {
                            console.log("Кнопка копирования нажата");
                            copyPhoneNumber();
                        });
                    });
                } else if (section === 'review') {
                    checkReviewCooldown();
                } else if (section === 'jobs') {
                    currentState = "jobs";
                    showContent(`
                        <div class="vacancy-block">
                            <h3>Продавец-консультант</h3>
                            <p>Эта вакансия для тех, кто влюблен в наш продукт, кто любит процесс работы с покупателем и хочет развиваться в розничном бизнесе.</p>
                            <h4>Обязанности:</h4>
                            <ul>
                                <li>Профессионально консультировать клиентов и успешно продавать электронные сигареты (аксессуары, комплектующие).</li>
                                <li>Задавать стандарты лучшего клиентского сервиса в розничной сети.</li>
                                <li>Предпродажная подготовка (проверка количества, комплектности, соответствия маркировки, внешнего вида).</li>
                                <li>Расчет покупателей на кассе.</li>
                                <li>Выкладка товара, ценники, маркировка.</li>
                                <li>Участие в инвентаризациях.</li>
                                <li>Поддержание чистоты и порядка в торговом зале.</li>
                                <li>Соблюдение корпоративных стандартов.</li>
                            </ul>
                            <h4>Требования:</h4>
                            <ul>
                                <li>Грамотная речь, активность, вежливость, внимательность, доброжелательность, стрессоустойчивость, ответственность.</li>
                                <li>Как плюс — знание кассовой дисциплины, умение работать с денежными средствами.</li>
                                <li>Умение работать в команде, желание продавать, коммуникабельность, наличие лидерских качеств.</li>
                            </ul>
                            <p>Мы рады принять в наш дружный, молодой коллектив коллег, которые хотят двигаться вперед!</p>
                            <h4>Условия работы:</h4>
                            <ul>
                                <li>Профессиональное обучение.</li>
                                <li>Работа в интересном и дружелюбном коллективе.</li>
                                <li>Оплата труда, зависящая от Вашей работы.</li>
                            </ul>
                            <p>Если всё изложенное выше Вам интересно, то мы ждём Ваших откликов!</p>
                            <h3 style="margin-top: 20px;">Анкета кандидата</h3>
                            <p>После рассмотрения резюме с Вами свяжется наш менеджер по подбору персонала.</p>
                            <div class="form-container">
                                <iframe src="https://forms.yandex.ru/u/68079eb7d046880cc459b018/?iframe=1"
                                    frameborder="0"
                                    name="ya-form-68079eb7d046880cc459b018"
                                    width="100%"
                                    height="480" style="border: none;"></iframe>
                            </div>

                        </div>
                    `, true);
                } else if (section === 'catalog') {
                    // Плавный переход
                    document.getElementById('content').classList.add('fade-out');
                    setTimeout(() => {
                        window.location.href = '/catalog';
                    }, 300);
                } else if (section === 'promotions') {
                    currentState = "promotions";
                    showPromotions();
                } else {
                    alert(`Раздел "${section}" в разработке!`);
                }
            }


            function checkReviewCooldown() {
                const lastTime = localStorage.getItem('lastReviewTime');
                if (lastTime) {
                    const now = Date.now();
                    const diff = now - parseInt(lastTime);
                    const remaining = 24 * 60 * 60 * 1000 - diff;
                    if (remaining > 0) {
                        const hours = Math.floor(remaining / (60 * 60 * 1000));
                        const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
                        showContent(`
                            <p>⚠️ Вы уже отправляли отзыв за последние 24 часа.</p>
                            <p>⌛️ До следующей возможности оставить отзыв осталось:<br><strong>${hours} ч ${minutes} мин</strong>.</p>
                        `, true);
                        return;
                    }
                }
                showReviewForm();
            }

            function showReviewForm() {
                currentState = "review";

                showContent(`
                    <h3>Оцените качество обслуживания</h3>
                    <div id="stars" style="font-size: 32px; margin-bottom: 10px;">
                        ${[1, 2, 3, 4, 5].map(i => `
                            <span class="star" data-stars="${i}" id="star${i}">⭐</span>
                        `).join('')}
                    </div>
                    <textarea id="reviewText" placeholder="Напишите ваш отзыв..." rows="5"
                              style="width: 90%; margin-top: 20px; border-radius: 10px; padding: 10px; border: 1px solid #ccc;"></textarea>
                    <button id="submit-review">Отправить</button>
                    <div id="toast" class="toast"></div>
                `, true, () => {
                    // ✅ Обработчик звёзд
                    const stars = document.querySelectorAll('.star');
                    stars.forEach(star => {
                        star.addEventListener('click', () => {
                            const count = parseInt(star.dataset.stars);
                            window.reviewStars = count;

                            stars.forEach((el, index) => {
                                if (index < count) {
                                    el.textContent = '🌟';
                                    el.classList.add('pop');
                                } else {
                                    el.textContent = '⭐';
                                    el.classList.remove('pop');
                                }
                            });
                        });
                    });

                    // ✅ Кнопка "Отправить"
                    const submitBtn = document.getElementById('submit-review');
                    submitBtn.addEventListener('click', () => {
                        const text = document.getElementById('reviewText').value.trim();

                        if (!window.reviewStars || window.reviewStars === 0) {
                            showToast("Пожалуйста, выберите оценку");
                            return;
                        }

                        if (text.length < 3) {
                            showToast("Пожалуйста, напишите отзыв");
                            return;
                        }

                        // Сохраняем и отправляем
                        sendReviewToTelegram(window.reviewStars, text);
                        localStorage.setItem('lastReviewTime', Date.now().toString());

                        showContent(`
                            <p>🙏 Спасибо за оставленный отзыв!</p>
                            <p>Нам важно ваше мнение 😊</p>
                            <button data-action="goHome">Главное меню</button>
                        `, true);
                    });

                    // Инициализация
                    window.reviewStars = 0;
                });
            }





            function selectStars(count) {
                window.reviewStars = count;
                for (let i = 1; i <= 5; i++) {
                    const el = document.getElementById(`star${i}`);
                    if (i <= count) {
                        el.textContent = '🌟';
                        el.classList.add('pop');
                    } else {
                        el.textContent = '⭐';
                        el.classList.remove('pop');
                    }
                }
            }

            function sendReviewToTelegram(stars, text) {
                const username = Telegram.WebApp.initDataUnsafe?.user?.username || 'Без username';
                const message = `⭐ Оценка: ${stars}/5\n✍️ Отзыв: ${text}\n👤 Пользователь: @${username}`;
                fetch('https://api.telegram.org/bot7210822073:AAFM7PAj5D9PEJrvwArF8rSaU4FqsyT-3ns/sendMessage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: '568416622',
                        text: message
                    })
                });
            }

            async function showPromotions() {
                currentState = "promotions"; // Добавляем сохранение состояния
                showContent(`<p>Загрузка акций...</p>`, true);
                
                try {
                    const response = await fetch('https://nekuri.by/api/news-feed.php');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const promotions = await response.json();
                    if (!Array.isArray(promotions)) throw new Error("Некорректный формат данных");
                    
                    localStorage.setItem('cachedPromotions', JSON.stringify(promotions));
                    localStorage.setItem('promotionsCacheTime', Date.now().toString());
                    
                    renderPromotions(promotions);
                } catch (error) {
                    console.error("Ошибка загрузки акций:", error);
                    const cached = localStorage.getItem('cachedPromotions');
                    if (cached) {
                        renderPromotions(JSON.parse(cached));
                        showToast("Используются кэшированные данные");
                    } else {
                        showContent(`
                            <p>Не удалось загрузить акции</p>
                            <button onclick="showPromotions()">Попробовать снова</button>
                            <button data-action="goHome">На главную</button>
                        `, true);
                    }
                }
            }
            let promotionsScrollPosition = 0;
            function renderPromotions(promotions) {
                if (!promotions || !Array.isArray(promotions)) {
                    showContent(`<p>Нет данных об акциях</p><button data-action="goHome">На главную</button>`, true);
                    return;
                }
            
                const promotionsHTML = promotions.map(promo => `
                    <div class="promotion-item" data-action="showPromoDetail" data-promo='${JSON.stringify(promo).replace(/'/g, "\\'")}'>
                        <img src="${promo.image}" alt="${promo.title}" 
                             onerror="this.onerror=null;this.src='/static/no-image.png'">
                        <h4>${promo.title}</h4>
                        ${promo.description ? `<p>${promo.description.substring(0, 100)}...</p>` : ''}
                    </div>
                `).join('');
            
                showContent(`
                    <h3>Актуальные акции</h3>
                    ${promotionsHTML.length ? promotionsHTML : '<p>Нет доступных акций</p>'}
                    <button data-action="goHome" style="margin-top: 20px;">На главную</button>
                `, true);
                setTimeout(() => {
                    window.scrollTo(0, promotionsScrollPosition);
                }, 50);
            }
            function showPromotionDetail(promoData) {
                currentState = "promotionDetail";
                
                promotionsScrollPosition = window.scrollY;
                window.scrollTo(0, 0);
                
                let processedContent = promoData.full_content || promoData.description || 'Нет содержания';
                processedContent = processedContent.replace(/<a\b[^>]*>(.*?)<\/a>/gi, '$1');
                processedContent = processedContent.replace(/<(?!\/?(p|br|img|h3|h4|ul|li|strong|em)(?=>|\s.*>))\/?.*?>/gi, '');
                processedContent = processedContent.replace(/<img([^>]+)src="([^"]+)"/gi, 
                    (match, attrs, src) => `<img${attrs}src="${src}" style="max-width:100%; height:auto; border-radius:8px; margin:10px 0;"`);
            
                showContent(`
                    <div class="promotion-detail">
                        <img src="${promoData.image}" alt="${promoData.title}" 
                             style="width:100%; border-radius:12px; margin-bottom:15px;"
                             onerror="this.onerror=null;this.src='/static/no-image.png'">
                        
                        <h3 style="margin-bottom:15px; color:#333;">${promoData.title}</h3>
                        
                        <div class="news-content" style="white-space:pre-line; line-height:1.5; font-size:16px; color:#444; margin-bottom:20px;">
                            ${processedContent}
                        </div>
                        
                        <button onclick="window.open('${promoData.link}', '_blank')" 
                                style="margin-top:20px; padding:12px 24px; background:#ff0000; color:white; border:none; border-radius:25px; font-size:16px; cursor:pointer; width:100%;">
                            Посмотреть на сайте
                        </button>
                    </div>
                `, true);
            }
            function goHome() {
                document.getElementById('content').classList.add('fade-out');
                setTimeout(() => {
                    showHome();
                }, 300);
            }

            
            
            
            function updateUserData(user) {
                document.getElementById('user-name').textContent = user.first_name || 'Не указано';
                document.getElementById('user-phone').textContent = user.phone || 'Не указан';
            }

            // Экспорт всех функций в глобальную область видимости
            // Основные функции приложения
            window.showHome = showHome;
            window.goHome = goHome;
            window.auth = auth; // Обновленная версия
            window.openCart = openCart;
            window.goBack = goBack;
            window.showSection = showSection;
            window.copyPhoneNumber = copyPhoneNumber;

            // Функции для магазинов
            window.showRegions = showRegions;
            window.showCities = showCities;
            window.showStores = showStores;
            window.showStoreDetails = showStoreDetails;
        });
    </script>
</body>
</html>
