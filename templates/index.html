<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        :root {
            --vh: 1vh;
        }
        html, body {
            height: calc(var(--vh, 1vh) * 100);
        }
    </style>
</head>
<body>
    <div class="header">
        <button id="back-button" onclick="goBack()" style="display: none;">
            <img src="/static/back.svg" alt="–ù–∞–∑–∞–¥">
        </button>
        <img src="/static/logo22.png" alt="–õ–æ–≥–æ—Ç–∏–ø" class="logo">
    </div>

    <div class="menu-vertical" id="content">
        <button onclick="showRegions()">–ê–¥—Ä–µ—Å–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤</button>
        <button onclick="showSection('catalog')">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</button>
        <button onclick="showSection('review')">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
        <button onclick="showSection('contacts')">–ö–æ–Ω—Ç–∞–∫—Ç—ã</button>
        <button onclick="showSection('jobs')">–í–∞–∫–∞–Ω—Å–∏–∏</button>
        <button onclick="showSection('promotions')">–ê–∫—Ü–∏–∏</button>
    </div>

    <div class="footer-buttons">
        <div id="home-button" onclick="goHome()">
            <img src="/static/home.svg" alt="–î–æ–º–æ–π">
        </div>
        <div id="login-button" onclick="auth()">
            <img src="/static/login.svg" alt="–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è">
        </div>
    </div>

    <div class="cart-button-container">
        <button onclick="openCart()" class="cart-button">
            <img src="/static/shop.svg" alt="–ö–æ—Ä–∑–∏–Ω–∞">
        </button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const setFullHeight = () => {
                document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
            };
            window.addEventListener('resize', setFullHeight);
            window.addEventListener('load', setFullHeight);
            setFullHeight();

            document.body.style.overflow = 'hidden';
            document.body.style.userSelect = 'none';
            document.addEventListener('dblclick', (e) => e.preventDefault());

            if (window.Telegram?.WebApp) {
                Telegram.WebApp.expand();
                Telegram.WebApp.ready();
            } else {
                document.body.innerHTML = "–û—à–∏–±–∫–∞: –æ—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram!";
                return;
            }

            let currentState = "home";
            let currentRegion = null;
            let currentCity = null;

            const contentDiv = document.getElementById('content');

            contentDiv.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-action]');
                if (btn) {
                    const action = btn.dataset.action;
                    console.log("üî• –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞:", action);

                    if (action === 'regions') showRegions();
                    else if (action.startsWith('section:')) showSection(action.split(':')[1]);
                    else if (action.startsWith('city:')) showCities(action.split(':')[1]);
                    else if (action.startsWith('store:')) {
                        const [_, city, region] = action.split(':');
                        showStores(city, region);
                    } else if (action.startsWith('detail:')) {
                        showStoreDetails(action.split(':')[1]);
                    } else if (action === 'goHome') {
                        goHome();
                    }
                }

                if (e.target.classList.contains('star')) {
                    const count = parseInt(e.target.dataset.stars);
                    selectStars(count);
                }

                const submitBtn = e.target.closest('#submit-review');
                if (submitBtn) {
                    submitReview();
                }
            });

            async function loadData(url) {
                try {
                    const response = await fetch(`/api/${url}`);
                    if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
                    return await response.json();
                } catch (error) {
                    console.error(error);
                    return null;
                }
            }

            function showContent(content, showBack = true) {
                const contentDiv = document.getElementById('content');
                document.getElementById('back-button').style.display = showBack ? 'block' : 'none';
                contentDiv.classList.add('hidden');
                setTimeout(() => {
                    contentDiv.innerHTML = content;
                    setTimeout(() => {
                        contentDiv.classList.remove('hidden');
                    }, 50);
                }, 300);
            }

            function showHome() {
                currentState = "home";
                showContent(`
                    <button data-action="regions">–ê–¥—Ä–µ—Å–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤</button>
                    <button data-action="section:catalog">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</button>
                    <button data-action="section:review">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
                    <button data-action="section:contacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</button>
                    <button data-action="section:jobs">–í–∞–∫–∞–Ω—Å–∏–∏</button>
                    <button data-action="section:promotions">–ê–∫—Ü–∏–∏</button>
                `, false);
            }

            function goBack() {
                if (currentState === "regions") {
                    showHome();
                } else if (currentState === "cities") {
                    showRegions();
                } else if (currentState === "stores") {
                    showCities(currentRegion);
                } else if (currentState === "storeDetails") {
                    showStores(currentCity, currentRegion);
                }
            }

            async function showRegions() {
                currentState = "regions";
                const regions = await loadData('regions');
                if (regions) {
                    const buttons = regions.map(region =>
                        `<button data-action="city:${region}">${region}</button>`).join('');
                    showContent(`<h3>–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å:</h3>${buttons}`, true);
                }
            }

            async function showCities(region) {
                currentState = "cities";
                currentRegion = region;
                const cities = await loadData(`cities/${region}`);
                if (cities) {
                    const buttons = cities.map(city =>
                        `<button data-action="store:${city}:${region}">${city}</button>`).join('');
                    showContent(`<h3>–ì–æ—Ä–æ–¥–∞ –≤ –æ–±–ª–∞—Å—Ç–∏ "${region}":</h3>${buttons}`, true);
                }
            }

            async function showStores(city, region) {
                currentState = "stores";
                currentCity = city;
                const stores = await loadData(`stores/${region}/${city}`);
                if (stores) {
                    const buttons = stores.map(store =>
                        `<button data-action="detail:${store.name}">${store.name}</button>`).join('');
                    showContent(`<h3>–ú–∞–≥–∞–∑–∏–Ω—ã –≤ –≥–æ—Ä–æ–¥–µ "${city}":</h3>${buttons}`, true);
                }
            }

            async function showStoreDetails(storeName) {
                currentState = "storeDetails";
                const stores = await loadData(`stores/${currentRegion}/${currentCity}`);
                const store = stores.find(s => s.name === storeName);
                if (store) {
                    showContent(`
                        <h3>${store.name}</h3>
                        <p><strong>–ê–¥—Ä–µ—Å:</strong> ${store.address}</p>
                        <p><strong>–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:</strong> ${store.hours.replace(/\n/g, '<br>')}</p>
                        <button onclick='window.open("${store.map_url}", "_blank")'>–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</button>
                    `, true);
                }
            }

            function showSection(section) {
                if (section === 'contacts') {
                    showContent(`
                        <h3>–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏</h3>
                        <button onclick="copyPhoneNumber()">–ü–æ–∑–≤–æ–Ω–∏—Ç—å: +375 29 225-13-34</button>
                        <button onclick="window.open('https://www.instagram.com/nekuri.by/', '_blank')">Instagram</button>
                        <button onclick="window.open('https://t.me/nekuri_by', '_blank')">Telegram –∫–∞–Ω–∞–ª</button>
                        <button onclick="window.open('https://t.me/nekuri_by_brest', '_blank')">Telegram —á–∞—Ç</button>
                        <button onclick="window.open('https://vk.com/nekuribrest', '_blank')">–í–ö–æ–Ω—Ç–∞–∫—Ç–µ</button>
                        <button onclick="window.open('https://www.tiktok.com/@nekuri.by', '_blank')">TikTok</button>
                    `, false);
                } else if (section === 'review') {
                    checkReviewCooldown();
                } else {
                    alert(`–†–∞–∑–¥–µ–ª "${section}" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!`);
                }
            }

            function checkReviewCooldown() {
                const lastTime = localStorage.getItem('lastReviewTime');
                if (lastTime) {
                    const now = Date.now();
                    const diff = now - parseInt(lastTime);
                    const remaining = 24 * 60 * 60 * 1000 - diff;
                    if (remaining > 0) {
                        const hours = Math.floor(remaining / (60 * 60 * 1000));
                        const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
                        showContent(`
                            <p>‚ö†Ô∏è –í—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –æ—Ç–∑—ã–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞.</p>
                            <p>‚åõÔ∏è –î–æ —Å–ª–µ–¥—É—é—â–µ–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –æ—Å—Ç–∞–ª–æ—Å—å:<br><strong>${hours} —á ${minutes} –º–∏–Ω</strong>.</p>
                        `, false);
                        return;
                    }
                }
                showReviewForm();
            }

            function showReviewForm() {
                showContent(`
                    <h3>–û—Ü–µ–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</h3>
                    <div id="stars" style="font-size: 32px;">
                        ${[1, 2, 3, 4, 5].map(i => `<span class="star" data-stars="${i}" id="star${i}">‚≠ê</span>`).join('')}
                    </div>
                    <textarea id="reviewText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤..." rows="5" style="width: 90%; margin-top: 20px;"></textarea>
                    <button id="submit-review" style="margin-top: 15px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    <div id="toast" class="toast"></div>
                `, false);
                window.reviewStars = 0;
            }

            function selectStars(count) {
                reviewStars = count;
                for (let i = 1; i <= 5; i++) {
                    const el = document.getElementById(`star${i}`);
                    if (i <= count) {
                        el.textContent = 'üåü';
                        el.classList.add('pop');
                    } else {
                        el.textContent = '‚≠ê';
                        el.classList.remove('pop');
                    }
                }
            }

            function submitReview() {
                const text = document.getElementById('reviewText').value.trim();
                if (reviewStars === 0) {
                    showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É");
                    return;
                }
                if (text.length < 3) {
                    showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤");
                    return;
                }
                sendReviewToTelegram(reviewStars, text);
                localStorage.setItem('lastReviewTime', Date.now().toString());
                showContent(`
                    <p>üôè –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –æ—Ç–∑—ã–≤!</p>
                    <p>–ù–∞–º –≤–∞–∂–Ω–æ –≤–∞—à–µ –º–Ω–µ–Ω–∏–µ üòä</p>
                    <button data-action="goHome">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
                `, false);
            }

            function sendReviewToTelegram(stars, text) {
                const username = Telegram.WebApp.initDataUnsafe?.user?.username || '–ë–µ–∑ username';
                const message = `‚≠ê –û—Ü–µ–Ω–∫–∞: ${stars}/5\n‚úçÔ∏è –û—Ç–∑—ã–≤: ${text}\nüë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @${username}`;
                fetch('https://api.telegram.org/bot7210822073:AAFM7PAj5D9PEJrvwArF8rSaU4FqsyT-3ns/sendMessage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: '568416622',
                        text: message
                    })
                });
            }

            function showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 2000);
            }

            function goHome() {
                showHome();
            }

            function auth() {
                alert("–§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!");
            }

            function openCart() {
                alert("–§—É–Ω–∫—Ü–∏—è –∫–æ—Ä–∑–∏–Ω—ã –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!");
            }

            window.showHome = showHome;
            window.goHome = goHome;
            window.auth = auth;
            window.openCart = openCart;
            window.goBack = goBack;
            window.showSection = showSection;
        });
    </script>

</body>
</html>
