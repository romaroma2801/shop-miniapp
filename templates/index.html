<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        :root {
            --vh: 1vh;
        }
        html, body {
            height: calc(var(--vh, 1vh) * 100);
        }
    </style>
</head>
<body>
    <div class="header">
        <button id="back-button" onclick="goBack()" style="display: none;">
            <img src="/static/back.svg" alt="–ù–∞–∑–∞–¥">
        </button>
        <img src="/static/logo22.png" alt="–õ–æ–≥–æ—Ç–∏–ø" class="logo">
    </div>

    <div class="menu-vertical" id="content">
        <button onclick="showRegions()">–ê–¥—Ä–µ—Å–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤</button>
        <button onclick="showSection('catalog')">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</button>
        <button onclick="showSection('review')">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
        <button onclick="showSection('contacts')">–ö–æ–Ω—Ç–∞–∫—Ç—ã</button>
        <button onclick="showSection('jobs')">–í–∞–∫–∞–Ω—Å–∏–∏</button>
        <button onclick="showSection('promotions')">–ê–∫—Ü–∏–∏</button>
    </div>

    <div class="footer-buttons">
        <div id="home-button" onclick="goHome()">
            <img src="/static/home.svg" alt="–î–æ–º–æ–π">
        </div>
        <div id="login-button" onclick="auth()">
            <img src="/static/login.svg" alt="–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è">
        </div>
    </div>

    <div class="cart-button-container">
        <button onclick="openCart()" class="cart-button">
            <img src="/static/shop.svg" alt="–ö–æ—Ä–∑–∏–Ω–∞">
        </button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const contentDiv = document.getElementById('content');
            if (!contentDiv) {
                console.error("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç #content!");
                return;
            }
            contentDiv.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-action]');
                if (btn) {
                    const action = btn.dataset.action;
                    console.log("üî• –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞:", action);
                    if (action === 'regions') showRegions();
                    else if (action.startsWith('section:')) showSection(action.split(':')[1]);
                }

                if (e.target.classList.contains('star')) {
                    selectStars(parseInt(e.target.dataset.stars));
                }

                if (e.target.id === 'submit-review') {
                    submitReview();
                }
            const setFullHeight = () => {
                document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
            };
            window.addEventListener('resize', setFullHeight);
            window.addEventListener('load', setFullHeight);
            setFullHeight();

            document.body.style.overflow = 'hidden';
            document.body.style.userSelect = 'none';
            document.addEventListener('dblclick', (e) => e.preventDefault());

            if (window.Telegram?.WebApp) {
                Telegram.WebApp.expand();
                Telegram.WebApp.ready();
            } else {
                document.body.innerHTML = "–û—à–∏–±–∫–∞: –æ—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram!";
                return;
            }

            let currentState = "home";
            let currentRegion = null;
            let currentCity = null;

            async function loadData(url) {
                try {
                    const response = await fetch(`/api/${url}`);
                    if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
                    return await response.json();
                } catch (error) {
                    console.error(error);
                    return null;
                }
            }

            function showContent(content, showBack = true) {
                const contentDiv = document.getElementById('content');
                document.getElementById('back-button').style.display = showBack ? 'block' : 'none';
                contentDiv.classList.add('hidden');
                setTimeout(() => {
                    contentDiv.innerHTML = content;
                    setTimeout(() => {
                        contentDiv.classList.remove('hidden');
                    }, 50);
                }, 300);
            }

            function goBack() {
                if (currentState === "regions") {
                    showHome();
                } else if (currentState === "cities") {
                    showRegions();
                } else if (currentState === "stores") {
                    showCities(currentRegion);
                } else if (currentState === "storeDetails") {
                    showStores(currentCity, currentRegion);
                }
            }

            function showHome() {
                currentState = "home";
                showContent(`
                    <button data-action="regions">–ê–¥—Ä–µ—Å–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤</button>
                    <button data-action="section:catalog">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</button>
                    <button data-action="section:review">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
                    <button data-action="section:contacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</button>
                    <button data-action="section:jobs">–í–∞–∫–∞–Ω—Å–∏–∏</button>
                    <button data-action="section:promotions">–ê–∫—Ü–∏–∏</button>
                `, false);
            }


            async function showRegions() {
                currentState = "regions";
                const regions = await loadData('regions');
                if (regions) {
                    const buttons = regions.map(region => `<button onclick='showCities(${JSON.stringify(region)})'>${region}</button>`).join('');
                    showContent(`<h3>–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å:</h3>${buttons}`, true);
                }
            }

            async function showCities(region) {
                currentState = "cities";
                currentRegion = region;
                const cities = await loadData(`cities/${region}`);
                if (cities) {
                    const buttons = cities.map(city => `<button onclick='showStores(${JSON.stringify(city)}, ${JSON.stringify(region)})'>${city}</button>`).join('');
                    showContent(`<h3>–ì–æ—Ä–æ–¥–∞ –≤ –æ–±–ª–∞—Å—Ç–∏ "${region}":</h3>${buttons}`, true);
                }
            }

            async function showStores(city, region) {
                currentState = "stores";
                currentCity = city;
                const stores = await loadData(`stores/${region}/${city}`);
                if (stores) {
                    const buttons = stores.map(store => `<button onclick='showStoreDetails(${JSON.stringify(store.name)})'>${store.name}</button>`).join('');
                    showContent(`<h3>–ú–∞–≥–∞–∑–∏–Ω—ã –≤ –≥–æ—Ä–æ–¥–µ "${city}":</h3>${buttons}`, true);
                }
            }

            async function showStoreDetails(storeName) {
                currentState = "storeDetails";
                const stores = await loadData(`stores/${currentRegion}/${currentCity}`);
                const store = stores.find(s => s.name === storeName);
                if (store) {
                    showContent(`
                        <h3>${store.name}</h3>
                        <p><strong>–ê–¥—Ä–µ—Å:</strong> ${store.address}</p>
                        <p><strong>–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:</strong> ${store.hours.replace(/\n/g, '<br>')}</p>
                        <button onclick='window.open("${store.map_url}", "_blank")'>–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</button>
                    `, true);
                }
            }

            function goHome() {
                showHome();
            }

            function auth() {
                alert("–§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!");
            }

            function openCart() {
                alert("–§—É–Ω–∫—Ü–∏—è –∫–æ—Ä–∑–∏–Ω—ã –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!");
            }

            function showSection(section) {
                if (section === 'contacts') {
                    showContent(`
                        <h3>–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏</h3>
                        <button onclick="copyPhoneNumber()">–ü–æ–∑–≤–æ–Ω–∏—Ç—å: +375 29 225-13-34</button>
                        <button onclick="window.open('https://www.instagram.com/nekuri.by/', '_blank')">Instagram</button>
                        <button onclick="window.open('https://t.me/nekuri_by', '_blank')">Telegram –∫–∞–Ω–∞–ª</button>
                        <button onclick="window.open('https://t.me/nekuri_by_brest', '_blank')">Telegram —á–∞—Ç</button>
                        <button onclick="window.open('https://vk.com/nekuribrest', '_blank')">–í–ö–æ–Ω—Ç–∞–∫—Ç–µ</button>
                        <button onclick="window.open('https://www.tiktok.com/@nekuri.by', '_blank')">TikTok</button>
                    `, false);
                } else {
                    alert(`–†–∞–∑–¥–µ–ª "${section}" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!`);
                }
            }
            function copyPhoneNumber() {
                const phoneNumber = '+375292251334';

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É clipboard API
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(phoneNumber).then(() => {
                        showToast('–ù–æ–º–µ—Ä —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
                    }).catch(err => {
                        fallbackCopyText(phoneNumber);
                    });
                } else {
                    // fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ / WebView
                    fallbackCopyText(phoneNumber);
                }
            }

            function fallbackCopyText(text) {
                const input = document.createElement('textarea');
                input.value = text;
                input.style.position = 'fixed';  // –Ω–µ scroll-–±–∞—Ä
                input.style.left = '-9999px';
                document.body.appendChild(input);
                input.focus();
                input.select();

                try {
                    document.execCommand('copy');
                    showToast('–ù–æ–º–µ—Ä —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
                } catch (err) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä: ' + err);
                }

                document.body.removeChild(input);
            }

            function showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 2000);
            }
            function showSection(section) {
                if (section === 'review') {
                    checkReviewCooldown();
                    return;
                }

                // –æ—Å—Ç–∞–ª—å–Ω–æ–µ –∫–∞–∫ —Ä–∞–Ω—å—à–µ
            }
            function checkReviewCooldown() {
                const lastTime = localStorage.getItem('lastReviewTime');
                if (lastTime) {
                    const now = Date.now();
                    const diff = now - parseInt(lastTime);
                    const remaining = 24 * 60 * 60 * 1000 - diff;
                    if (remaining > 0) {
                        const hours = Math.floor(remaining / (60 * 60 * 1000));
                        const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
                        showContent(`
                            <p>‚ö†Ô∏è –í—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –æ—Ç–∑—ã–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞.</p>
                            <p>‚åõÔ∏è –î–æ —Å–ª–µ–¥—É—é—â–µ–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –æ—Å—Ç–∞–ª–æ—Å—å:<br><strong>${hours} —á ${minutes} –º–∏–Ω</strong>.</p>
                        `, false);
                        return;
                    }
                }
                showReviewForm();
            }
            function showReviewForm() {
                showContent(`
                    <h3>–û—Ü–µ–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</h3>
                    <div id="stars" style="font-size: 32px;">
                        ${[1,2,3,4,5].map(i => `<span class="star" data-stars="${i}" id="star${i}">‚≠ê</span>`).join('')}
                    </div>
                    <textarea id="reviewText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤..." rows="5" style="width: 90%; margin-top: 20px;"></textarea>
                    <button id="submit-review" style="margin-top: 15px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    <div id="toast" class="toast"></div>
                `, false);

                window.reviewStars = 0;
            }

            function selectStars(count) {
                reviewStars = count;
                for (let i = 1; i <= 5; i++) {
                    const el = document.getElementById(`star${i}`);
                    if (i <= count) {
                        el.textContent = 'üåü';
                        el.classList.add('pop');
                    } else {
                        el.textContent = '‚≠ê';
                        el.classList.remove('pop');
                    }
                }
            }
            function submitReview() {
                const text = document.getElementById('reviewText').value.trim();
                if (reviewStars === 0) {
                    showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É");
                    return;
                }
                if (text.length < 3) {
                    showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤");
                    return;
                }

                // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏–ª–∏ –≤ Telegram
                sendReviewToTelegram(reviewStars, text);

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                localStorage.setItem('lastReviewTime', Date.now().toString());

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å
                showContent(`
                    <p>üôè –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –æ—Ç–∑—ã–≤!</p>
                    <p>–ù–∞–º –≤–∞–∂–Ω–æ –≤–∞—à–µ –º–Ω–µ–Ω–∏–µ üòä</p>
                    <button onclick="goHome()">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
                `, false);
            }
            function sendReviewToTelegram(stars, text) {
                const username = Telegram.WebApp.initDataUnsafe?.user?.username || '–ë–µ–∑ username';
                const message = `‚≠ê –û—Ü–µ–Ω–∫–∞: ${stars}/5\n‚úçÔ∏è –û—Ç–∑—ã–≤: ${text}\nüë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @${username}`;
    
                fetch('https://api.telegram.org/bot'TELEGRAM_TOKEN'/sendMessage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: '568416622',
                        text: message
                    })
                });
            }

            // –î–µ–ª–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ
            window.showRegions = showRegions;
            window.showCities = showCities;
            window.showStores = showStores;
            window.showStoreDetails = showStoreDetails;
            window.showHome = showHome;
            window.goHome = goHome;
            window.auth = auth;
            window.openCart = openCart;
            window.goBack = goBack;
            window.showSection = showSection;

        });
    </script>
</body>
</html>
