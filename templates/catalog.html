<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Каталог</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/css/style.css">
  <style>
    #search-bar {
      padding: 10px;
      width: 100%;
      margin: 10px 0;
      border-radius: 12px;
      border: 1px solid #ccc;
      font-size: 16px;
      box-sizing: border-box;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .category-button {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 16px;
      box-shadow: 2px 2px 6px #ccc;
      padding: 12px;
      text-align: center;
      cursor: pointer;
    }
    .category-button img {
      max-height: 80px;
      margin-bottom: 8px;
    }
    .product-card {
      border: 1px solid #eee;
      border-radius: 16px;
      box-shadow: 2px 2px 8px #ccc;
      padding: 10px;
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      height: 100%;
      box-sizing: border-box;
    }
    .product-card img {
      max-width: 100%;
      max-height: 120px;
      object-fit: contain;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .product-card h4 {
      font-size: 14px;
      font-weight: normal;
      margin: 6px 0;
      text-align: center;
    }
    .product-card p.price {
      font-size: 16px;
      font-weight: bold;
      margin: 6px 0;
    }
    .map-button, .add-button {
      width: 100%;
      box-sizing: border-box;
      margin-top: auto;
      border-radius: 25px;
      padding: 10px;
      font-size: 14px;
    }
    .map-button {
      background: white;
      color: #ff0000;
      border: 1px solid #ff0000;
    }
    .add-button {
      background: #ff0000;
      color: white;
      border: none;
    }
    .product-detail-card {
      border: 1px solid #eee;
      border-radius: 16px;
      box-shadow: 2px 2px 8px #ccc;
      padding: 16px;
      background: #fff;
      margin: 10px;
      box-sizing: border-box;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="/static/logo22.png" alt="Логотип" class="logo">
  </div>

  <button id="back-button" onclick="goBack()">
    <img src="/static/back.svg" alt="Назад">
  </button>

  <div class="menu-vertical" id="content"></div>

  <div class="footer-buttons">
    <div id="home-button" onclick="location.href='/'">
      <img src="/static/home.svg" alt="Домой">
    </div>
    <div id="login-button" onclick="goToLogin()">
      <img src="/static/login.svg" alt="Личный кабинет">
    </div>
  </div>

  <div class="cart-button-container">
    <button class="cart-button" id="cart-button" onclick="openCart()">
      <img src="/static/shop.svg" alt="Корзина">
    </button>
  </div>

  <script>
    let catalogData = {};
    let navigationStack = [];

    async function loadCatalog() {
      const res = await fetch('/api/catalog');
      catalogData = await res.json();
      showMainCategories();
    }

    function scrollTop() {
      document.getElementById('content').scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showMainCategories() {
      navigationStack = [];
      const content = document.getElementById('content');
      content.innerHTML = getSearchBar() + '<div class="grid">' +
        [
          { id: '1', name: 'Парогенераторы', icon: 'vape.png' },
          { id: '2', name: 'Жидкости для вейпа', icon: 'juice.png' },
          { id: '3', name: 'Запчасти и комплектующие', icon: 'spanner.png' },
          { id: '4', name: 'Кальяны и комплектующие', icon: 'hookah.png' },
          { id: '5', name: 'Самозамес', icon: 'test.png' },
          { id: '6', name: 'Уценённый товар', icon: 'sale.png' }
        ].map(cat => `
          <div class="category-button" onclick="openCategory('${cat.id}')">
            <img src="/static/${cat.icon}" alt="${cat.name}">
            <div>${cat.name}</div>
          </div>`).join('') + '</div>';
      bindSearch();
      scrollTop();
    }

    function getSearchBar() {
      return '<input type="text" id="search-bar" placeholder="Поиск по каталогу">';
    }

    function openCategory(catId) {
      const category = catalogData[catId];
      if (!category) return;
      navigationStack.push(() => showMainCategories());
      if (!category.subcategories || Object.keys(category.subcategories).length === 0) {
        showProducts(category.products);
      } else {
        showSubcategories(category.subcategories);
      }
    }

    function showSubcategories(subcategories) {
      navigationStack.push(() => showSubcategories(subcategories));
      const content = document.getElementById('content');
      content.innerHTML = getSearchBar() + '<div class="grid">' +
        Object.values(subcategories).map(sub => `
          <div class="category-button" onclick='openSubcategory(${JSON.stringify(sub).replace(/'/g, "\'").replace(/"/g, '&quot;')})'>
            <img src="${fixImg(sub.icon)}">
            <div>${sub.name}</div>
          </div>`).join('') + '</div>';
      bindSearch();
      scrollTop();
    }

    function openSubcategory(sub) {
      navigationStack.push(() => openSubcategory(sub));
      if (sub.subcategories && Object.keys(sub.subcategories).length) {
        showSubcategories(sub.subcategories);
      } else {
        showProducts(sub.products);
      }
    }

    function showProducts(products) {
      navigationStack.push(() => showProducts(products));
      const content = document.getElementById('content');
      content.innerHTML = getSearchBar() + '<div class="grid">' +
        products.map(p => `
          <div class="product-card" onclick='showProductDetail(${JSON.stringify(p).replace(/'/g, "\'").replace(/"/g, '&quot;')})'>
            <img src="${fixImg(p.image)}" alt="${p.title}">
            <h4>${p.title}</h4>
            <p class="price">${parseFloat(p.price).toFixed(2)} BYN</p>
            <div class="${p.available === 'out_of_stock' ? 'map-button' : 'add-button'}"
                 onclick="event.stopPropagation(); alert('Смотреть можно, трогать нельзя!')">
              ${p.available === 'out_of_stock' ? 'Недоступен' : 'Добавить в корзину'}
            </div>
          </div>`).join('') + '</div>';
      bindSearch();
      scrollTop();
    }

    function showProductDetail(product) {
      navigationStack.push(() => showProducts([product]));
      const content = document.getElementById('content');
      content.innerHTML = getSearchBar() + `
        <div class="product-detail-card">
          <img src="${fixImg(product.image)}" alt="${product.title}" style="width:100%; max-height:200px; object-fit:contain;">
          <h4>${product.title}</h4>
          <p>${product.description}</p>
          <p class="price">${parseFloat(product.price).toFixed(2)} BYN</p>
          <div class="${product.available === 'out_of_stock' ? 'map-button' : 'add-button'}"
               onclick="event.stopPropagation(); alert('Смотреть можно, трогать нельзя!')">
            ${product.available === 'out_of_stock' ? 'Недоступен' : 'Добавить в корзину'}
          </div>
        </div>`;
      bindSearch();
      scrollTop();
    }

    function bindSearch() {
      const input = document.getElementById('search-bar');
      if (input) {
        input.addEventListener('input', () => {
          const query = input.value.toLowerCase();
          const allProducts = Object.values(catalogData).flatMap(cat => cat.products || []);
          const filtered = allProducts.filter(p => p.title.toLowerCase().includes(query));
          showProducts(filtered);
        });
        input.focus();
      }
    }

    function fixImg(path) {
      return 'https://nekuri.by' + path.replace(/\\/g, '').replace(/ /g, '%20');
    }

    function goBack() {
      const last = navigationStack.pop();
      if (last) last();
    }

    function openCart() {
      alert('Функция корзины в разработке!');
    }

    function goToLogin() {
      location.href = '/user';
    }

    loadCatalog();
  </script>
</body>
</html>
