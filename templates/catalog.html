<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Каталог</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/css/style.css">
  <style>
    #search-bar {
      padding: 10px;
      width: calc(100% - 40px);
      margin: 10px 20px;
      border-radius: 12px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    .subheader {
      font-weight: bold;
      margin: 10px 0;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="/static/logo22.png" alt="Логотип" class="logo">
  </div>

  <button id="back-button" onclick="goBack()">
    <img src="/static/back.svg" alt="Назад">
  </button>

  <div class="menu-vertical" id="content">
    <input type="text" id="search-bar" placeholder="Поиск по каталогу" oninput="searchCatalog(this.value)">
  </div>

  <div class="footer-buttons">
    <div id="home-button" onclick="location.href='/'">
      <img src="/static/home.svg" alt="Домой">
    </div>
    <div id="login-button" onclick="goToLogin()">
      <img src="/static/login.svg" alt="Личный кабинет">
    </div>
  </div>

  <div class="cart-button-container">
    <button class="cart-button" id="cart-button" onclick="openCart()">
      <img src="/static/shop.svg" alt="Корзина">
    </button>
  </div>

  <script>
    let catalogData = {};
    let navigationStack = [];

    async function loadCatalog() {
      const res = await fetch('/api/catalog');
      catalogData = await res.json();
      showCategories();
    }

    function showCategories() {
      navigationStack = [];
      const content = document.getElementById('content');
      content.innerHTML = '<input type="text" id="search-bar" placeholder="Поиск по каталогу" oninput="searchCatalog(this.value)">' +
        '<div class="grid">' + [
          { id: '1', name: 'Парогенераторы', icon: 'vape.png' },
          { id: '2', name: 'Жидкости для вейпа', icon: 'juice.png' },
          { id: '3', name: 'Запчасти и комплектующие', icon: 'spanner.png' },
          { id: '4', name: 'Кальяны и комплектующие', icon: 'hookah.png' },
          { id: '5', name: 'Самозамес', icon: 'test.png' },
          { id: '6', name: 'Уценённый товар', icon: 'sale.png' },
        ].map(cat => `
          <div class="category-button" onclick="openCategory('${cat.id}')">
            <img src="/static/icons/${cat.icon}" alt="${cat.name}">
            <div>${cat.name}</div>
          </div>
        `).join('') + '</div>';
    }

    function openCategory(catId) {
      navigationStack.push(() => showCategories());
      const category = catalogData[catId];
      if (!category) return;
      if (category.subcategories && Object.keys(category.subcategories).length) {
        const content = document.getElementById('content');
        content.innerHTML = '<input type="text" id="search-bar" placeholder="Поиск по каталогу" oninput="searchCatalog(this.value)">' +
          '<div class="grid">' +
          Object.values(category.subcategories).map(sub => `
            <div class="category-button" onclick='openSubcategory(${JSON.stringify(sub)})'>
              <img src="${sub.icon || '/static/icons/juice.png'}">
              <div>${sub.name}</div>
            </div>
          `).join('') + '</div>';
      } else {
        showProducts(category.products);
      }
    }

    function openSubcategory(sub) {
      navigationStack.push(() => openCategory(sub.parent_id));
      if (sub.subcategories && Object.keys(sub.subcategories).length) {
        const content = document.getElementById('content');
        content.innerHTML = '<input type="text" id="search-bar" placeholder="Поиск по каталогу" oninput="searchCatalog(this.value)">' +
          '<div class="grid">' +
          Object.values(sub.subcategories).map(sub2 => `
            <div class="category-button" onclick='openSubcategory(${JSON.stringify(sub2)})'>
              <img src="${sub2.icon || '/static/icons/juice.png'}">
              <div>${sub2.name}</div>
            </div>
          `).join('') + '</div>';
      } else {
        showProducts(sub.products);
      }
    }

    function showProducts(products) {
      navigationStack.push(() => showCategories());
      const content = document.getElementById('content');
      content.innerHTML = '<input type="text" id="search-bar" placeholder="Поиск по каталогу" oninput="searchCatalog(this.value)">' +
        products.map(p => `
          <div class="product-card">
            <img src="${p.image}" alt="${p.title}">
            <h4>${p.title}</h4>
            <p>Цена: ${p.price} BYN</p>
            <div class="${p.available === 'out_of_stock' ? 'map-button' : 'add-button'}"
                 onclick="event.stopPropagation(); alert('Смотреть можно, трогать нельзя!')">
              ${p.available === 'out_of_stock' ? 'Нет в наличии' : 'Добавить в корзину'}
            </div>
          </div>
        `).join('');
    }

    function searchCatalog(query) {
      query = query.toLowerCase();
      const allProducts = Object.values(catalogData).flatMap(cat => cat.products);
      const filtered = allProducts.filter(p => p.title.toLowerCase().includes(query));
      showProducts(filtered);
    }

    function goBack() {
      const last = navigationStack.pop();
      if (last) last();
    }

    function openCart() {
      alert('Функция корзины в разработке!');
    }

    function goToLogin() {
      location.href = '/user';
    }

    loadCatalog();
  </script>
</body>
</html>
